#!/bin/bash

usage()
{
	printf "USAGE: push <target-dir> mmc\n"
	printf "       push <target-dir> net <ip-address>\n"
}

if [ "x${2}" = "x" ]; then
	printf "Missing transfer type!\n"
	usage
	exit 1
fi

transfer_type=${2}

if [ "x${1}" = "x" ]; then
	printf "Missing target directory!\n"
	usage
	exit 1
fi

target_dir=${1}

if [ -d /media/$USER ]; then
	media="/media/$USER"
else
	if [ -d /run/media/$USER ]; then
		media="/run/media/$USER"
	else
		printf "Unknown SD/MMC media directory location!\n"
		exit 1
	fi
fi

push_bootloader="1"

echo "$@" | grep -q noboot
if [ "$?" = "0" ]; then
	push_bootloader="0"
fi

case "${transfer_type}" in
	mmc)
		sudo rsync -aP ${target_dir}/boot ${media}/rootfs/ && \
		sudo rsync -aP ${target_dir}/lib/modules ${media}/rootfs/lib/ && sync && \
		if [ "${push_bootloader}" = "1" ]; then
			sudo cp -v ${target_dir}/boot/MLO-* ${media}/BOOT/MLO && sync && \
			sudo cp -v ${target_dir}/boot/u-boot-*.img ${media}/BOOT/u-boot.img && sync
		fi
		;;
	net)
		if [ "x${3}" = "x" ]; then
			printf "Missing IP address!\n"
			usage
			exit 1
		fi
		rsync -aP ${target_dir}/boot root@${3}:/
		rsync -aP ${target_dir}/lib/modules root@${3}:/lib/
		if [ "${push_bootloader}" = "1" ]; then
			rsync -P ${target_dir}/boot/MLO-* root@${3}:/media/BOOT/MLO
			rsync -P ${target_dir}/boot/u-boot-*.img root@${3}:/media/BOOT/u-boot.img
		fi
		;;
	*)
		printf "Transfer type [${transfer_type}] not implemented.\n"
		usage
		exit 1
esac
